@model IEnumerable<Book>
@{
    ViewBag.Title = "æ›¸ç±ç®¡ç† (.NET Core 8)";
    Layout = "_Layout";
}

<h2>æ›¸ç±ç®¡ç†</h2>

@if (User.Identity?.IsAuthenticated == true && User.IsInRole("Admin"))
{
    <h3>æ–°å¢æ›¸ç±</h3>
    <form asp-controller="Book" asp-action="Add" method="post" class="mb-4">
        @Html.AntiForgeryToken()
        <div class="mb-3">
            <label class="form-label">ğŸ“– æ›¸å</label>
            <input name="title" class="form-control" style="max-width:400px" placeholder="è«‹è¼¸å…¥æ›¸ç±æ¨™é¡Œ" required />
            <div class="form-text">æ›¸ç±çš„ä¸»è¦æ¨™é¡Œ</div>
        </div>
        <div class="mb-3">
            <label class="form-label">ğŸ“ æè¿°</label>
            <textarea name="description" class="form-control" style="max-width:400px;height:80px" placeholder="è«‹è¼¸å…¥æ›¸ç±æè¿°ï¼ˆé¸å¡«ï¼‰"></textarea>
            <div class="form-text">æ›¸ç±çš„è©³ç´°æè¿°æˆ–æ‘˜è¦</div>
        </div>
        <div class="mb-3">
            <label class="form-label">ğŸ“ ä½ç½®</label>
            <input name="position" class="form-control" style="max-width:400px" placeholder="ä¾‹å¦‚: A-12, B-05" />
            <div class="form-text">æ›¸æ¶æ¨™ç±¤æˆ–ä½ç½®ç·¨è™Ÿ</div>
        </div>
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" style="max-width:400px">
                â• æ–°å¢æ›¸ç±
            </button>
        </div>
    </form>
}
else if (User.Identity?.IsAuthenticated == true)
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> åªæœ‰ç®¡ç†å“¡æ‰èƒ½æ–°å¢æ›¸ç±
    </div>
}
else
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> è«‹å…ˆ <a href="@Url.Action("Login", "Account")">ç™»å…¥</a> ä»¥ä½¿ç”¨æ›¸ç±ç®¡ç†åŠŸèƒ½
    </div>
}

<hr />

<h3>æŸ¥è©¢æ›¸ç± (å¯ç”¨ä½ç½® / æ›¸å / é—œéµå­—)</h3>
<div>
    <input id="q_query" placeholder="å‘é‡æ¯”å° (é—œéµå­—)" style="width:300px" />
    <input id="q_position" placeholder="ä½ç½® (ç²¾ç¢ºæŸ¥) e.g. A-12" style="width:150px" />
    <input id="q_title" placeholder="æ›¸å (æ¨¡ç³ŠæŸ¥)" style="width:200px" />
    <button id="btnSearch">æœå°‹</button>
</div>

<div id="resultArea" style="margin-top:20px"></div>

<hr />

<h3>ç›®å‰æ›¸ç±</h3>
<table border="1" cellpadding="4" cellspacing="0" class="table table-striped">
    <tr class="text-center">
        <th>ID</th>
        <th>Title</th>
        <th>Description</th>
        <th>Position</th>
        <th>æ“ä½œ</th>
    </tr>
    @foreach (var b in Model)
    {
        <tr>
            <td>@b.BookId</td>
            <td>@b.Title</td>
            <td>@b.Description</td>
            <td>@b.Position</td>
            <td>
                <a href="@Url.Action("Details", "Book", new { id = b.BookId })" class="btn btn-sm btn-outline-info">è©³ç´°</a>
                @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Admin"))
                {
                    <a href="@Url.Action("Edit", "Book", new { id = b.BookId })" class="btn btn-sm btn-outline-primary">ç·¨è¼¯</a>
                    <form method="post" asp-action="Delete" asp-route-id="@b.BookId" style="display:inline;" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±å—ï¼Ÿ');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline-danger">åˆªé™¤</button>
                    </form>
                }
            </td>
        </tr>
    }
</table>

@section Scripts {
    <script>
        $(function() {
            $('#btnSearch').click(function() {
                var q = $('#q_query').val();
                var p = $('#q_position').val();
                var t = $('#q_title').val();
                
                $.post('@Url.Action("Search", "Book")', { 
                    query: q, 
                    position: p, 
                    title: t,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }, function(html) {
                    $('#resultArea').html(html);
                }).fail(function() {
                    $('#resultArea').html('<div class="alert alert-danger">æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤</div>');
                });
            });
        });
    </script>
}
